#!/bin/bash

echo "ğŸ” VÃ‰RIFICATION DE LA CONFIGURATION RAILWAY BACKEND"
echo "===================================================="
echo ""

echo "ğŸ“‹ Variables requises pour le backend Railway:"
echo ""
echo "1. MYSQLHOST (fourni par Railway MySQL service)"
echo "2. MYSQLPORT (fourni par Railway MySQL service)"
echo "3. MYSQLDATABASE (fourni par Railway MySQL service)"
echo "4. MYSQLUSER (fourni par Railway MySQL service)"
echo "5. MYSQLPASSWORD (fourni par Railway MySQL service)"
echo "6. JWT_SECRET (Ã  crÃ©er manuellement)"
echo "7. NODE_ENV=production"
echo "8. CORS_ORIGIN=https://gestion-chantier-kenia-production.up.railway.app"
echo ""

echo "âš ï¸  PORT ne doit PAS Ãªtre dÃ©fini manuellement (Railway le fournit automatiquement)"
echo ""

echo "===================================================="
echo "ğŸ¯ ACTIONS Ã€ FAIRE DANS RAILWAY:"
echo "===================================================="
echo ""

echo "1ï¸âƒ£ VÃ©rifier que MySQL est actif:"
echo "   - Dans Railway, liste des services"
echo "   - Service 'MySQL' doit avoir le badge 'Active' (vert)"
echo ""

echo "2ï¸âƒ£ Configurer les variables dans Backend:"
echo "   a) Allez dans: Backend > Variables"
echo "   b) Cliquez sur 'New Variable' > 'Add Reference'"
echo "   c) Ajoutez ces variables avec rÃ©fÃ©rences MySQL:"
echo ""
echo "      MYSQLHOST = \${{MySQL.MYSQLHOST}}"
echo "      MYSQLPORT = \${{MySQL.MYSQLPORT}}"
echo "      MYSQLDATABASE = \${{MySQL.MYSQLDATABASE}}"
echo "      MYSQLUSER = \${{MySQL.MYSQLUSER}}"
echo "      MYSQLPASSWORD = \${{MySQL.MYSQLPASSWORD}}"
echo ""
echo "   d) Ajoutez ces variables manuellement:"
echo ""
echo "      JWT_SECRET = un_secret_fort_et_unique_2025"
echo "      NODE_ENV = production"
echo "      CORS_ORIGIN = https://gestion-chantier-kenia-production.up.railway.app"
echo ""

echo "3ï¸âƒ£ VÃ©rifier que PORT n'est PAS dÃ©fini manuellement:"
echo "   - Dans Variables, ne doit PAS y avoir de variable 'PORT'"
echo "   - Railway la fournit automatiquement"
echo ""

echo "4ï¸âƒ£ RedÃ©ployer le backend:"
echo "   - Deployments > menu â‹® > Redeploy"
echo ""

echo "===================================================="
echo "ğŸ” DIAGNOSTIC DES LOGS ACTUELS"
echo "===================================================="
echo ""

echo "Vos logs montrent:"
echo "  ğŸš€ Serveur dÃ©marrÃ© sur le port 5000  â† PROBLÃˆME!"
echo "  Stopping Container"
echo ""
echo "Cela signifie:"
echo "  âŒ Le backend ne lit pas la variable PORT de Railway"
echo "  âŒ Il utilise le port par dÃ©faut 5000"
echo "  âŒ Railway attend le port 8080"
echo "  âŒ Railway arrÃªte le container car il ne rÃ©pond pas"
echo ""

echo "===================================================="
echo "âœ… APRÃˆS CONFIGURATION CORRECTE"
echo "===================================================="
echo ""

echo "Les logs devraient montrer:"
echo ""
echo "  ğŸš€ DÃ©marrage de l'application Gestion Chantiers..."
echo "  â³ Attente de la base de donnÃ©es..."
echo "  ğŸ“¦ Mode production: vÃ©rification des migrations..."
echo "  âœ… DÃ©marrage du serveur..."
echo "  ğŸ”’ CORS configurÃ© pour: https://gestion-chantier-kenia-production.up.railway.app"
echo "  âœ… ConnectÃ© Ã  la base de donnÃ©es MySQL"
echo "  ğŸš€ Serveur dÃ©marrÃ© sur le port 8080  â† CORRECT!"
echo "  ğŸŒ Environnement: production"
echo ""
echo "  (Le container ne s'arrÃªte plus)"
echo ""

echo "===================================================="
echo "ğŸ§ª TEST FINAL"
echo "===================================================="
echo ""

echo "Une fois le backend redÃ©ployÃ© avec les bonnes variables:"
echo ""
echo "  curl https://faithful-empathy-production.up.railway.app/api/health"
echo ""
echo "Devrait retourner:"
echo ""
echo '  {"status":"OK","timestamp":"...","database":"Connected"}'
echo ""

echo "===================================================="
echo ""
echo "ğŸ“ Si le problÃ¨me persiste:"
echo "   - Copiez les nouveaux logs Railway"
echo "   - VÃ©rifiez que MySQL est bien 'Active'"
echo "   - VÃ©rifiez que toutes les variables \${{MySQL.*}} sont prÃ©sentes"
echo ""
